<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Feather Force // Bluejay & Cardinal</title>
  <style>
    :root{
      --bg:#0a1020;--bg2:#101a33;--panel:#111a2e;--line:#2a3d73;--text:#eaf1ff;
      --blue:#49a4ff;--red:#ff5a67;--gold:#ffd166;--ok:#34d399;
    }
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 700px at 50% -10%,#1a2a54 0,var(--bg) 45%,#070b16 100%);color:var(--text)}
    .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{font-weight:800;letter-spacing:.5px}
    .brand .b{color:var(--blue)} .brand .r{color:var(--red)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .controls input,.controls button,.controls select{background:var(--panel);border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:10px}
    .controls button{cursor:pointer}
    .controls button:hover{filter:brightness(1.12)}
    .hud{display:flex;gap:12px;margin:10px 0 14px;flex-wrap:wrap}
    .chip{background:#0f1730;border:1px solid #29417f;border-radius:999px;padding:6px 10px;font-size:13px}
    canvas{width:100%;max-width:1060px;height:auto;border:1px solid #2d427d;border-radius:14px;background:linear-gradient(#091224,#050912);box-shadow:0 18px 50px rgba(0,0,0,.45)}
    .note{opacity:.85;font-size:12px;margin-top:8px}
  </style>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">FEATHER FORCE // <span class="b">BLUEJAY</span> + <span class="r">CARDINAL</span></div>
    <div class="controls">
      <select id="birdSel"><option value="jay">Bluejay</option><option value="cardinal">Cardinal</option></select>
      <input id="room" placeholder="room code (e.g. NEST-42)" />
      <button id="hostBtn">Host</button>
      <button id="joinBtn">Join</button>
    </div>
  </div>
  <div class="hud">
    <div class="chip" id="conn">Offline</div>
    <div class="chip" id="score">Score: 0</div>
    <div class="chip" id="lives">Lives: 3</div>
    <div class="chip">WASD / Arrows move · J shoot</div>
  </div>
  <canvas id="game" width="1060" height="600"></canvas>
  <div class="note">Online co-op: host creates room; partner joins same code. Host simulates enemies; client syncs live via WebRTC.</div>
</div>
<script>
const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');
const W=canvas.width,H=canvas.height;
const state={players:{},bullets:[],enemies:[],stars:[],score:0,lives:3,host:false,me:null,conn:null,peer:null,tick:0,gameOver:false};
const keys={}; for(let i=0;i<160;i++)state.stars.push({x:Math.random()*W,y:Math.random()*H,s:Math.random()*2+1,v:Math.random()*0.6+0.2});
const hud={conn:document.getElementById('conn'),score:document.getElementById('score'),lives:document.getElementById('lives')};

function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function makePlayer(id,bird,x,y){return{id,bird,x,y,vx:0,vy:0,speed:4.1,cool:0,hp:3,dir:1};}
function colorBird(b){return b==='jay'?'#49a4ff':'#ff5a67'}
function roomId(raw){return 'ff-'+(raw||'nest').toLowerCase().replace(/[^a-z0-9-]/g,'').slice(0,24)}

function drawBird(p){
  ctx.save(); ctx.translate(p.x,p.y); ctx.scale(p.dir,1);
  const c=colorBird(p.bird);
  ctx.fillStyle=c; ctx.beginPath(); ctx.ellipse(0,0,22,14,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#dfe9ff'; ctx.beginPath(); ctx.arc(-6,-4,4,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#111'; ctx.beginPath(); ctx.arc(-7,-4,1.2,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#ffd166'; ctx.beginPath(); ctx.moveTo(16,-2); ctx.lineTo(28,1); ctx.lineTo(16,4); ctx.closePath(); ctx.fill();
  ctx.fillStyle='rgba(255,255,255,.35)'; ctx.beginPath(); ctx.ellipse(-2,4,11,5,0,0,Math.PI*2); ctx.fill();
  ctx.restore();
}
function shoot(p){ if(p.cool>0||state.gameOver)return; p.cool=10; state.bullets.push({x:p.x+p.dir*28,y:p.y,vx:p.dir*9,owner:p.id}); }
function spawnEnemy(){
  const side=Math.random()<.5?0:1,x=side?W+30:-30,y=90+Math.random()*(H-180);
  state.enemies.push({x,y,vx:side?- (2+Math.random()*1.8):(2+Math.random()*1.8),hp:2,r:18});
}

function updateLocal(){
  const me=state.players[state.me]; if(!me||state.gameOver)return;
  const left=keys['ArrowLeft']||keys['a'],right=keys['ArrowRight']||keys['d'],up=keys['ArrowUp']||keys['w'],down=keys['ArrowDown']||keys['s'];
  me.vx=(right?1:0)-(left?1:0); me.vy=(down?1:0)-(up?1:0);
  me.x=clamp(me.x+me.vx*me.speed,30,W-30); me.y=clamp(me.y+me.vy*me.speed,50,H-30);
  if(me.vx!==0)me.dir=me.vx>0?1:-1;
  if((keys['j']||keys[' '])) shoot(me);
  if(me.cool>0)me.cool--;
}

function hostSim(){
  if(state.tick%52===0)spawnEnemy();
  for(const b of state.bullets){b.x+=b.vx}
  state.bullets=state.bullets.filter(b=>b.x>-40&&b.x<W+40);
  for(const e of state.enemies){e.x+=e.vx}
  for(const e of state.enemies){
    for(const b of state.bullets){
      const dx=e.x-b.x,dy=e.y-b.y;if(dx*dx+dy*dy< (e.r+4)*(e.r+4)){e.hp--; b.x=1e9; if(e.hp<=0){state.score+=100;e.dead=true;}}
    }
    for(const id in state.players){const p=state.players[id];const dx=e.x-p.x,dy=e.y-p.y;if(dx*dx+dy*dy< (e.r+16)*(e.r+16)){e.dead=true;state.lives--; if(state.lives<=0)state.gameOver=true;}}
  }
  state.enemies=state.enemies.filter(e=>!e.dead&&e.x>-60&&e.x<W+60);
}

function draw(){
  ctx.clearRect(0,0,W,H);
  // stars/parallax
  for(const s of state.stars){s.x-=s.v; if(s.x<0)s.x=W; ctx.fillStyle='rgba(255,255,255,.7)'; ctx.fillRect(s.x,s.y,s.s,s.s)}
  ctx.strokeStyle='rgba(80,120,220,.22)'; for(let i=0;i<6;i++){ctx.beginPath();ctx.moveTo(0,90+i*80);ctx.lineTo(W,90+i*80);ctx.stroke();}
  for(const b of state.bullets){ctx.fillStyle='#ffd166';ctx.fillRect(b.x-4,b.y-2,8,4)}
  for(const e of state.enemies){ctx.fillStyle='#8b5cf6';ctx.beginPath();ctx.arc(e.x,e.y,e.r,0,Math.PI*2);ctx.fill();ctx.fillStyle='#f8f';ctx.fillRect(e.x-8,e.y-2,16,4)}
  Object.values(state.players).forEach(drawBird);
  if(state.gameOver){ctx.fillStyle='rgba(0,0,0,.55)';ctx.fillRect(0,0,W,H);ctx.fillStyle='#fff';ctx.font='700 56px system-ui';ctx.fillText('GAME OVER',W/2-170,H/2);ctx.font='500 26px system-ui';ctx.fillText('Refresh or host/join a new room',W/2-170,H/2+46)}
  hud.score.textContent='Score: '+state.score; hud.lives.textContent='Lives: '+state.lives;
}

function netSend(){
  if(!state.conn||state.conn.open!==true)return;
  const me=state.players[state.me];
  if(state.host){
    state.conn.send({t:'state',players:state.players,bullets:state.bullets,enemies:state.enemies,score:state.score,lives:state.lives,gameOver:state.gameOver});
  }else if(me){
    state.conn.send({t:'input',x:me.x,y:me.y,dir:me.dir,shoot:(keys['j']||keys[' '])?1:0,bird:me.bird});
  }
}

function step(){
  state.tick++;
  updateLocal();
  if(state.host){
    hostSim();
    if(state.conn&&state.conn.open&&state.conn._lastInput){
      const p=state.players['peer']; const i=state.conn._lastInput; if(p){p.x=i.x;p.y=i.y;p.dir=i.dir;p.bird=i.bird||p.bird;if(i.shoot)shoot(p);} }
  }
  if(state.tick%2===0)netSend();
  draw(); requestAnimationFrame(step);
}

function setConn(txt,ok){hud.conn.textContent=txt; hud.conn.style.borderColor=ok?'#2c8f68':'#8a2b3d';}

function startHost(){
  const bird=document.getElementById('birdSel').value; const rid=roomId(document.getElementById('room').value);
  state.host=true; state.me='host'; state.players={'host':makePlayer('host',bird,150,H/2)}; state.score=0;state.lives=3;state.bullets=[];state.enemies=[];state.gameOver=false;
  state.peer=new Peer(rid);
  state.peer.on('open',()=>setConn('Hosting '+rid,true));
  state.peer.on('connection',c=>{state.conn=c; state.players['peer']=makePlayer('peer',bird==='jay'?'cardinal':'jay',260,H/2+70); hookConn();});
}
function startJoin(){
  const bird=document.getElementById('birdSel').value; const rid=roomId(document.getElementById('room').value);
  state.host=false; state.me='peer'; state.players={'peer':makePlayer('peer',bird,260,H/2+70)}; state.score=0;state.lives=3;state.bullets=[];state.enemies=[];state.gameOver=false;
  state.peer=new Peer();
  state.peer.on('open',id=>{state.conn=state.peer.connect(rid,{reliable:true}); hookConn(); setConn('Joining '+rid+'…',false);});
}
function hookConn(){
  if(!state.conn)return;
  state.conn.on('open',()=>setConn(state.host?'Client connected':'Connected',true));
  state.conn.on('close',()=>setConn('Disconnected',false));
  state.conn.on('error',()=>setConn('Connection error',false));
  state.conn.on('data',d=>{
    if(d.t==='state'&&!state.host){
      state.players=d.players||state.players; state.players[state.me]=state.players[state.me]||makePlayer(state.me,document.getElementById('birdSel').value,220,H/2);
      state.bullets=d.bullets||[]; state.enemies=d.enemies||[]; state.score=d.score||0; state.lives=d.lives||3; state.gameOver=!!d.gameOver;
    }
    if(d.t==='input'&&state.host){state.conn._lastInput=d;}
  });
}

window.addEventListener('keydown',e=>keys[e.key]=true);
window.addEventListener('keyup',e=>keys[e.key]=false);
document.getElementById('hostBtn').onclick=startHost;
document.getElementById('joinBtn').onclick=startJoin;
setConn('Offline',false);
step();
</script>
</body>
</html>
